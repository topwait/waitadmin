layui.config({
    base: '/static/common/library/layui/exts/'
}).extend({
    echarts:      'echarts/echarts',
    echartsTheme: 'echarts/echartsTheme',
    tinymce:      'tinymce/tinymce',
    inputTags:    'inputTags/inputTags',
    iconPicker:   'iconPicker/iconPicker',
    treeTable:    'treeTable/treeTable',
    xmSelect:     'xmSelect/xmSelect'
}).use(function () {
    layTips();
    layTheme();
    layThumbUpload();
    layThumbDelete();
    layThumbSelect();

    // 页面加载完毕再显示
    $().ready(function() {
        $('html').removeAttr('style');
    });
});

/**
 * 工具集合
 */
let lock = {};
let load = {};
let waitUtil = {
    // 请求
    ajax: function (options) {
        let loading = undefined;
        return new Promise((resolve, reject) => {
            $.ajax({
                url: options.url,
                data: options.data || {},
                type: options.type || 'GET',
                async: options.async || true,
                timeout: options.timeout || 3000,
                dataType: 'json',
                beforeSend: function () {
                    if (lock[options.url.replace('/', '_')] !== undefined) {
                        return layer.msg('操作频繁,请稍后再试', {time: 1500});
                    }
                    lock[options.url.replace('/', '_')] = true;
                    load[options.url.replace('/', '_')] = setTimeout(function () {
                        loading = layer.load(1, {shade: [0.1, '#fff']})
                    }, 1800);
                },
                success: function (res) {
                    let fulShow = options.fulShow === false ? false : true;
                    let errShow = options.errShow === false ? false : true;
                    if (fulShow===true && res.code===0) {
                        layer.msg(res.msg, {icon: 1, time: 1800});
                    }
                    if (errShow===true && res.code!==0) {
                        layer.msg(res.msg, {icon: 2, time: 1800});
                    }
                    resolve(res);
                },
                error: function(jqXHR, error, errorThrown) {
                    layer.msg('请求错误:'+error, {icon: 2, time: 1800}, function () {
                        reject(error);
                    });
                },
                complete: function (xhr, status) {
                    if (status === 'timeout') {
                        layer.msg('请求超时，请重试', {icon: 2, time: 1800}, function () {
                            if (loading !== undefined) {
                                layer.close(loading)
                            }
                            return false;
                        });
                    }

                    clearTimeout(load[options.url.replace('/', '_')]);
                    delete load[options.url.replace('/', '_')];
                    delete lock[options.url.replace('/', '_')];
                    if (loading !== undefined) {
                        layer.close(loading)
                    }
                }
            });
        });
    }
    // 弹窗
    ,popup: function (options) {
        let width   = options.area[0] || '90%';
        let height  = options.area[1] || '90%';
        let parents = options.parent || false;

        if (width.endsWith('px')) {
            if ($(window).width() <= width.replace('/px/', '')) {
                width = '90%';
            }
        }

        if (height.endsWith('px')) {
            if ($(window).height() <= height.replace('/px/', '')) {
                height = '90%';
            }
        }

        if ($(window).width() < 768 || layui.device().mobile) {
            width = '90%';
            height = '90%';
        }

        let layOpen = parents ? parent.layer : layer;
        layOpen.open({
            type: options.type || 2
            ,title: options.title
            ,skin: options.skin || 'layer-skin-black'
            ,maxmin: true
            ,shadeClose: options.shadeClose || false
            ,area: [width, height]
            ,content: options.url,
            success: function(layero, index){
                let iframeWindow  = $(layero).find('iframe')[0].contentWindow;
                let iframeElement = $(layero).find('iframe').contents();

                iframeElement.find("#closePopupWindow").click(function(){
                    layer.close(index)
                });

                options.success(iframeWindow, index, iframeElement);
            }
        });
    }
    // 事件
    ,event: function (options) {
        let active = options;

        // 绑定自定义事件
        $(document).on('click', '*[lay-event]', function (e) {
            let type = $(this).attr('lay-event');
            active[type] ? active[type].call(this, $(this), e) : '';
        });

        // 绑定数据表事件
        layui.use(['element', 'table', 'form'], function () {
            // 监听表复选框事件
            layui.table.on('checkbox(wait-table-list)', function(obj){
                let nodes  = $('.layui-btn[lay-event="leave"]');
                if (nodes.length) {
                    let arrays = layui.table.checkStatus('wait-table-list').data;
                    if (arrays.length && nodes.length) {
                        nodes.removeClass('layui-btn-forbid')
                    } else {
                        nodes.addClass('layui-btn-forbid')
                    }
                }
            });

            // 监听表格头部事件
            layui.table.on('toolbar(wait-table-list)', function(obj) {
                let type = obj.event;
                if (type === 'refresh' && !active[type]) {
                    layui.table.reload('wait-table-list');
                } else {
                    active[type] ? active[type].call(this, obj) : '';
                }
            });

            // 监听表格右侧事件
            layui.table.on('tool(wait-table-list)', function(obj) {
                let type = obj.event;
                active[type] ? active[type].call(this, obj) : '';
            });

            // 监听是否切换
            layui.form.on('switch(switch-status)', function(obj) {
                active['change'] ? active['change'].call(this, obj) : '';
            });
        });

        return active;
    }
    // 搜索
    ,search: function (table) {
        // 监听搜索
        layui.form.on('submit(search)', function(data) {
            table.reload({
                where: waitUtil.filterNullObj(data.field),
                page: {curr: 1}
            });
        });

        // 清空搜索
        layui.form.on('submit(clear-search)', function() {
            $(".layui-search input").val("");
            $(".layui-search select").val("");
            layui.form.render("select");
            table.reload({
                where: [],
                page: {curr: 1}
            });
        });
    }
    // 表格
    ,table: function (options) {
        return layui.table.render({
            elem: options.elem
            ,url: options.url
            ,method: options.method || 'GET'
            ,toolbar: options.toolbar === false ? false : options.toolbar || '#toolbar'
            ,defaultToolbar: options.defaultToolbar === false ? [] : ['filter', 'exports', 'print']
            ,cols: options.cols
            ,page: options.page === undefined ? true : options.page
            ,height: options.height || null
            ,limit: options.limit || 20
            ,limits: options.limits || [20, 40, 60, 80, 100, 120, 140, 160]
            ,parseData: function(res) {
                if (res.data.list === undefined) {
                    return {
                        'code': res.code
                        ,'msg': res.msg
                        ,'extend': res.extend || []
                        ,'data': res.data
                    };
                } else {
                    return {
                        'code': res.code
                        ,'msg': res.msg
                        ,'count': res.data.count
                        ,'extend': res.data.extend || []
                        ,'data': res.data.list
                    };
                }
            },
            done: function(res){
                setTimeout(function () {
                    // 适配行高
                    $('.layui-table-main tr').each(function (index, val) {
                        $($('.layui-table-fixed-l .layui-table-body tbody tr')[index]).height($(val).height());
                        $($('.layui-table-fixed-r .layui-table-body tbody tr')[index]).height($(val).height());
                    });

                    // 回调事件
                    if (options.done) {
                        options.done(res);
                    }
                }, 100);
            }
        });
    }
    // 复选
    ,checkbox: function (options) {
        options    = options ? options : {};
        let key    = options.key    || 'id';
        let filter = options.filter || 'wait-table-list';
        let layero = options.layero ? options.layero.layui.table : layui.table;
        let arrays = layero.checkStatus(filter).data;
        if (!key) return arrays;
        let data = [];
        arrays.forEach(function (item) {
            data.push(item[key]);
        });
        return data;
    }
    // 图库
    ,uploader: function (options) {
        options = options === undefined ? {} : options;
        let limit  = options.limit  || 1;
        let type   = options.type   || 'image';
        let width  = options.width  || '850px';
        let height = options.height || '600px';
        if (layui.device().mobile) { width = '95%'; height = '95%'; }

        return new Promise((resolve) => {
            let typeNum = type === 'image' ? 10 : 20;
            let paths = window.location.pathname.split('/')[1];
            let route = '/' + paths + 'attach/index?type=' + typeNum + '&limit='+limit;
            parent.layer.open({
                type: 2
                ,title: '选择附件'
                ,shadeClose: true
                ,maxmin: true
                ,skin: 'layer-skin-black'
                ,anim: 1
                ,shade: 0.3
                ,area: [width, height]
                ,content: route
                ,success: function (layero, index) {
                    let iframeNode = $(layero).find('iframe').contents();
                    let iframeWin = $(layero).find('iframe')[0].contentWindow;

                    iframeNode.find('#okFile').click(function () {
                        let urls = iframeWin.getUrlArr();

                        if (urls.length <= 0) {
                            parent.layer.msg('请至少选择一个!');
                            return false;
                        }

                        if (urls.length > limit) {
                            parent.layer.msg("限制只能选" + limit + "个");
                        }

                        parent.layer.close(index);
                        resolve(urls);
                    });
                }
            });
        });
    }
    // 锁定按钮
    ,locking: function (options) {
        let icon = 'layui-icon layui-icon-loading ';
        let anim = 'layui-anim layui-anim-rotate layui-anim-loop';
        $(options).addClass('layui-btn-forbid');
        $(options).prepend('<i class="'+icon+ anim +'" style="font-size:13px;"></i> ');
    }
    // 解锁按钮
    ,unlock: function (options) {
        $(options).removeClass('layui-btn-forbid');
        $(options).children('i').remove();
    }
    // 过滤对象空字段
    ,filterNullObj: function (obj) {
        return Object.keys(obj).reduce((acc, key) => {
            if (obj[key] !== '' && obj[key] !== null && obj[key] !== undefined) {
                acc[key] = obj[key];
            }
            return acc;
        }, {});
    }
}

/**
 * 悬停提示
 */
function layTips() {
    $('body').on('mouseenter', '*[lay-tips]', function(){
        let that = $(this);
        let tips      = that.attr('lay-tips');
        let offset    = that.attr('lay-offset');
        let direction = that.attr('lay-direction');
        let index = layer.tips(tips, this, {
            tips: direction || 1
            ,time: -1
            ,success: function(layero){
                if(offset){
                    layero.css('margin-left', offset + 'px');
                }
            }
        });
        that.data('index', index);
    }).on('mouseleave', '*[lay-tips]', function(){
        layer.close($(this).data('index'));
    });
}

/**
 * 渲染主题
 */
function layTheme() {
    let theme = waitCache.getItem('theme');
    if (theme && theme != waitConfig.theme) {
        $('body').attr('data-theme', theme);
    }
}

/**
 * 附件删除
 */
function layThumbDelete() {
    $(document).on('click', '.thumbnail .preview i', function () {
        let elem   = $(this).parents('.thumbnail');
        let type   = elem.attr('data-type') || 'image';
        let limit  = parseInt(elem.attr('data-limit') || 1);

        $(this).parent().remove();
        let previews = elem.children('.musters .preview');
        if (previews.length <= 0 || previews.length < limit) {
            elem.children('.builder').removeClass('layui-hide');
        }
    });
}

/**
 * 附件上传
 */
function layThumbUpload() {
    let $body = $('body');
    let builder = $body.find('.thumbnail .layui-auto-call');

    builder.each(function () {
        // 附件节点
        let that   = $(this);
        let node   = $(this).parents('.thumbnail');
        // 附件类型
        let type   = node.attr('data-type');
        // 附件字段
        let field  = node.attr('data-field');
        // 限制数量
        let limit  = parseInt(node.attr('data-limit') || 1);
        // 是否隐藏
        let hide   = parseInt(node.attr('data-hide') || 1);
        // 是否水印
        let water  = Boolean(node.attr('data-water') || true);
        // 上传引擎
        let engine = node.attr('data-engine') || 'permanent';
        // 路径名称
        let pathname = window.location.pathname.split('/')[1];

        let url;
        let accept;
        let acceptMime;
        let exts;
        let size;
        let input;
        switch (type||'image') {
            case 'image':
                input = 'img';
                accept = 'images';
                acceptMime = 'image/*';
                exts = 'png|jpg|jpeg|gif|bmp|ico';
                size = 10485760 / 10;
                field = field === undefined ? 'image' : field;
                url = '/' + pathname + '/upload/'+ engine + '?type=picture';
                break;
            case 'video':
                input = 'video';
                accept = 'video';
                acceptMime = 'video/*';
                exts = 'mp4|mp3|avi|flv|rmvb|mov';
                size = 31457280 / 10;
                field = field === undefined ? 'video' : field;
                url = '/' + pathname + '/upload/' + engine + '?type=video';
                break;
            case 'package':
                break;
            case 'document':
                break;
        }

        function getTemplate(type, url) {
            switch (type) {
                case 'image':
                    return '<img src="'+url+'">';
                    break;
                case 'video':
                    return '<video src="'+url+'"></video>'
                    break;
                case 'package':
                    return '<img src="'+url+'">';
                    break;
                case 'document':
                    return '<img src="'+url+'">';
            }
        }

        let layerIndex;
        layui.upload.render({
            elem: that
            ,url: url
            ,field: 'file'
            ,accept: accept
            ,acceptMime: acceptMime
            ,exts: exts
            ,size: size
            ,data: {water: water, hide: hide}
            ,before: function () {
                layerIndex = layer.msg('上传中...', {
                    icon: 16,
                    shade: 0.01,
                    time: 0
                });
            }
            ,error: function (e) {
                layer.close(layerIndex);
                layer.msg(e, {icon: 2, time: 1500});
            }
            ,done: function(res){
                layer.close(layerIndex);
                if (res.code === 0) {
                    let node = this.elem;
                    if (!node.prev().hasClass('musters')) {
                        node.before('<div class="musters"></div>');
                    }

                    if (node.prev().find('.preview').length >= limit) {
                        return layer.msg('limit exceeded error');
                    }

                    let thatMask = node.parent().parent();
                    if (node.prev().find('.preview').length>0 || thatMask.prev().find('.preview').length>0) {
                        let elNo = node.parent().hasClass('mask') ? thatMask : that;
                        let elem = elNo.prev().find('.preview');
                        elem.children('input').val(res.data.url);
                        elem.children(input).attr('src', res.data.url);
                        elem.removeClass('layui-hide');
                        node.addClass('layui-hide');
                    } else {
                        let template = '';
                        template += '<div class="preview">';
                        template += '<input type="hidden" name="' + field + '" value="' + res.data.url + '">';
                        template += '<i class="layui-icon layui-icon-close"></i>';
                        template += getTemplate(type, res.data.url);
                        if (node.parent().hasClass('mask')) {
                            node.parent().parent().prev().append(template);
                            if (node.parent().parent().prev().find('.preview').length >= limit) {
                                node.parent().parent().addClass('layui-hide');
                            }
                        } else {
                            node.prev().append(template);
                            if (node.prev().find('.preview').length >= limit) {
                                node.addClass('layui-hide');
                            }
                        }
                    }
                } else {
                    return layer.msg(res.msg);
                }
            }
        });
    });
}

/**
 * 附件选择
 */
function layThumbSelect() {
    $(document).on('click', '.thumbnail .layui-auto', function () {
        let that   = $(this);
        let elem   = $(this).parents('.thumbnail');
        let type   = elem.attr('data-type')  || 'image';
        let limit  = parseInt(elem.attr('data-limit') || 1);
        let field  = elem.attr('data-field')  || 'image';
        let width  = elem.attr('data-width')  || '850px';
        let height = elem.attr('data-height') || '600px';

        switch (type) {
            case 'image':
                field = field === undefined ? 'image' : field;
                break;
            case 'video':
                field = field === undefined ? 'video' : field;
                break;
        }

        function getTemplate(type, url) {
            switch (type) {
                case 'image':
                    return '<img src="'+url+'">';
                    break;
                case 'video':
                    return '<video src="'+url+'"></video>'
                    break;
            }
        }

        return new Promise((resolve) => {
            let typeNum = type === 'image' ? 10 : 20;
            let paths = window.location.pathname.split('/')[1];
            let route = `/${paths}/attach/index?limit=${limit}&type=${typeNum}`;

            parent.layer.open({
                type: 2
                ,title: '选择附件'
                ,shadeClose: true
                ,maxmin: true
                ,skin: 'layer-skin-black'
                ,anim: 1
                ,shade: 0.3
                ,area: [width, height]
                ,content: route
                ,success: function (layero, index) {
                    let iframeNode = $(layero).find('iframe').contents();
                    let iframeWin = $(layero).find('iframe')[0].contentWindow;

                    iframeNode.find('#okFile').click(function () {
                        let urls = iframeWin.getUrlArr();

                        if (urls.length <= 0) {
                            parent.layer.msg('请至少选择一张图片!');
                            return false;
                        }

                        if (urls.length > limit) {
                            parent.layer.msg("限制只能选" + limit + "张");
                        }

                        if (that.prev().find('.preview').length >= limit) {
                            return layer.msg('limit exceeded error');
                        }

                        urls.forEach(function (item) {
                            let template = '';
                            template += '<div class="preview">';
                            template += '<input type="hidden" name="'+ field +'" value="'+ item.url +'">';
                            template += '<i class="layui-icon layui-icon-close"></i>';
                            template += getTemplate(type, item.url);

                            let thatMask = that.parent().parent();
                            if (that.prev().find('.preview').length>0 || thatMask.prev().find('.preview').length>0) {
                                let elNo = that.parent().hasClass('mask') ? thatMask : that;
                                let elem = elNo.prev().find('.preview');
                                let input = typeNum === 10 ? 'img' : 'video';
                                elem.children('input').val(item.url);
                                elem.children(input).attr('src', item.url);
                                elem.removeClass('layui-hide');
                                that.prev().addClass('layui-hide');
                            } else {
                                if (that.parent().hasClass('mask')) {
                                    that.parent().parent().prev().append(template);
                                    if (thatMask.prev().find('.preview').length >= limit) {
                                        thatMask.addClass('layui-hide');
                                    }
                                } else {
                                    that.prev().append(template);
                                    if (that.prev().find('.preview').length >= limit) {
                                        that.addClass('layui-hide');
                                    }
                                }
                            }
                        });

                        parent.layer.close(index);
                        resolve(urls);
                    });
                }
            });
        });
    });
}
