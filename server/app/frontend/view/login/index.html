<div class="layout-global-session">
    {if $scene == 'login'}
    {include file="login/logon" /}
    {/if}

    {if $scene == 'register'}
    {include file="login/register" /}
    {/if}

    {if $scene == 'resetting'}
    {include file="login/resetting" /}
    {/if}
</div>


{block name="js"}
<script>
    layui.use(['form'], function () {
        let $ = layui.$;
        let form = layui.form;
        let sceneArray = {'login': 101, 'register': 102, 'resetting': 103}
        let sceneCode = sceneArray['{$scene}'];
        let timer = null;

        form.render();

        timing($('.get_code'))

        // 账号登录
        form.on('submit(loginSubmit)', function(data) {
            waitUtil.locking(this)
            waitUtil.ajax({
                url: "{:route('login/login')}",
                type: 'POST',
                data: data.field
            }).then((res) => {
                if (res.code === 0) {
                    setTimeout(() => {
                        parent.location.href = '/';
                    }, 1500);
                } else {
                    waitUtil.unlock(this);
                }
            }).catch(() => {
                waitUtil.unlock(this);
            });
        });

        // 账号注册
        form.on('submit(registerSubmit)', function(data) {
            waitUtil.locking(this);
            if (!data.field['agreement']) {
                waitUtil.unlock(this);
                return layer.msg('请阅读并同意服务协议', {icon: 2});
            }

            waitUtil.ajax({
                url: "{:route('login/register')}",
                type: 'POST',
                data: data.field
            }).then((res) => {
                if (res.code === 0) {
                    setTimeout(() => {
                        parent.location.href = '/';
                    }, 1500);
                } else {
                    waitUtil.unlock(this);
                }
            }).catch(() => {
                waitUtil.unlock(this);
            });
        });

        // 忘记密码
        form.on('submit(resetSubmit)', function(data) {
            waitUtil.locking(this);
            if (!waitCheck.isMobile(data.field['mobile']) && !waitCheck.isEmail(data.field['mobile'])) {
                waitUtil.unlock(this);
                return layer.msg('手机号/邮箱格式不正确', {icon: 2});
            }

            if (data.field['newPassword'].length < 6 || data.field['newPassword'].length > 20) {
                waitUtil.unlock(this);
                return layer.msg('密码必须在6~20个字符内', {icon: 2});
            }

            if (data.field['newPassword'] !== data.field['okPassword']) {
                waitUtil.unlock(this);
                return layer.msg('两次密码输入不一致', {icon: 2});
            }

            waitUtil.ajax({
                url: "{:route('login/forgetPwd')}",
                type: 'POST',
                data: data.field
            }).then((res) => {
                if (res.code === 0) {
                    setTimeout(() => {
                        parent.location.href = '/';
                    }, 1500);
                } else {
                    waitUtil.unlock(this);
                }
            });
        });

        // 微信登录
        $(document).on('click', '#wxLogin', function () {
            $('.ac-login').addClass('layui-hide');
            $('.wx-login').removeClass('layui-hide');

            waitUtil.ajax({
                url: "{:route('login/login')}",
                fulShow: false,
                type: 'POST',
                data: {scene: 'oa'}
            }).then((res) => {
                $('.wx-login .qrCode img').attr('src', res.data.url);
                ticketByUser(res.data.key);
            });
        });

        // 切换方式
        $(document).on('click', '.wx-login .switch', function () {
            $('.wx-login').addClass('layui-hide');
            $('.ac-login').removeClass('layui-hide');
        })

        // 验证码
        $(document).on('click', '.get_code', function () {
            let that  = $(this);
            let scene = $(this).attr('data-type');
            let value = $(this).parent().parent().find('input[name="mobile"]').val();

            let sendStatus = waitCache.get('sms:code:'+scene);
            if (sendStatus) {
                return layer.msg('操作频繁,请稍后再试');
            }

            // 默认发送短信
            let url = '{:route("index/sendSms")}';
            let data = {scene: scene, mobile: value};

            switch (scene) {
                case '101': // 短信登录
                case '102': // 短信注册
                    if (!value) {
                        return layer.tips('手机号码不能为空', '#mobile', {tips: 1});
                    }

                    if (!waitCheck.isMobile(value)) {
                        return layer.tips('手机号码格式错误', '#mobile', {tips: 1});
                    }
                    break;
                case '103': // 找回密码
                    if (!waitCheck.isMobile(value) && !waitCheck.isEmail(value)) {
                        return layer.tips('手机号码/邮箱格式不正确', '#mobile', {tips: 1});
                    }

                    if (waitCheck.isEmail(value)) {
                        url = '{:route("index/sendEmail")}';
                        data = {scene: scene, email: value};
                    }
                    break;
                default:
                    return layer.msg('操作异常!');
            }

            waitUtil.locking(this);
            waitUtil.ajax({
                url: url,
                type: 'POST',
                data: data
            }).then((res) => {
                waitCache.set('sms:code:'+scene, 60, 60)
                waitUtil.unlock(this);
                if (res.code === 0) {
                    timing(that);
                } else {
                    waitCache.remove('sms:code:'+scene)
                }
            }).catch(() => {
                waitCache.remove('sms:code:'+scene)
                waitUtil.unlock(this);
            });
        });

        // 倒计时
        function timing(that) {
            let { expire, value } = waitCache.get('sms:code:'+sceneCode, true);
            if (!expire || !value) {
                return;
            }

            let surplusTime = value;
            that.html(surplusTime+'秒后可再次发送');
            that.addClass('layui-btn-forbid');
            let timer = setInterval(function () {
                surplusTime = surplusTime - 1;
                waitCache.set('sms:code:'+sceneCode, surplusTime, expire);
                if (surplusTime >= 0) {
                    that.html(surplusTime + '秒后可再次发送');
                } else {
                    that.html('重新发送');
                    clearInterval(timer);
                    waitCache.remove('sms:code:'+sceneCode);
                    that.removeClass('layui-btn-forbid');
                }
            }, 1000);
        }

        function ticketByUser(key) {
            timer = setInterval(function () {
                waitUtil.ajax({
                    url: "{:route('login/ticketByUser')}?key="+key,
                    fulShow: false,
                    type: 'GET'
                }).then((res) => {
                    if (res.data.status === undefined) {
                        clearInterval(timer);
                    } else if (res.data.status === 2) {
                        clearInterval(timer);
                    } else if (res.data.status === 1) {
                        layui.msg('登录成功')
                    }
                });
            }, 1500)
        }
    });
</script>
{/block}