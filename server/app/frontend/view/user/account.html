{extend name="common/layoutEasy" /}

{block name="body"}
<div class="user-modular-account">
    <div class="user-modular-title">帐户设置</div>
    <div class="layui-tab">
        <ul class="layui-tab-title">
            <li class="layui-this">基本信息</li>
            <li>修改头像</li>
            <li>账号绑定</li>
        </ul>
        <div class="layui-tab-content">
            <!-- 基本信息 -->
            <div class="layui-tab-item layui-show">
                <form class="layui-form information">
                    <div class="layui-form-item">
                        <label for="account" class="layui-form-label">登录账号</label>
                        <div class="layui-input-inline">
                            <input type="text" id="account" value="{$detail.account}"
                                   autocomplete="off" readonly class="layui-input layui-disabled">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label for="register" class="layui-form-label">注册时间</label>
                        <div class="layui-input-inline">
                            <input type="text" id="register" value="{$detail.create_time}"
                                   autocomplete="off" readonly class="layui-input layui-disabled">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label for="nickname" class="layui-form-label">用户昵称</label>
                        <div class="layui-input-inline">
                            <input type="text" id="nickname" name="nickname" value="{$detail.nickname}"
                                   autocomplete="off" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">用户性别</label>
                        <div class="layui-input-block">
                            <input type="radio" name="gender" value="0" title="保密" {if $detail.gender==0}checked{/if}>
                            <input type="radio" name="gender" value="1" title="男" {if $detail.gender==1}checked{/if}>
                            <input type="radio" name="gender" value="2" title="女" {if $detail.gender==2}checked{/if}>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label for="sign" class="layui-form-label">个性签名</label>
                        <div class="layui-input-inline">
                            <textarea id="sign" name="sign" placeholder="这家伙很懒什么都没有留下~" class="layui-textarea">{$detail.sign??''}</textarea>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label"></label>
                        <div class="layui-input-inline">
                            <button type="button" class="layui-btn layui-btn-default" lay-filter="updateSubmit" lay-submit>确认修改</button>
                        </div>
                    </div>
                </form>
            </div>
            <!-- 修改头像 -->
            <div class="layui-tab-item">
                <form class="layui-form avatar">
                    <div class="explain"></div>
                    <div class="upload">
                        <div class="wrapper">
                            <input type="hidden" id="avatar" name="avatar" value="{$detail.avatar}">
                            <img src="{$detail.avatar}" alt="avatar" id="uploadAvatar">
                        </div>
                        <button type="button" class="layui-btn layui-btn-default" lay-filter="saveAvatar" lay-submit>确认修改</button>
                    </div>
                    <div class="clearfix"></div>
                </form>
            </div>
            <!-- 账号绑定 -->
            <div class="layui-tab-item">
                <ul class="binding">
                    <li>
                        <div class="icon">
                            <i class="layui-icon layui-icon-email"></i>
                        </div>
                        <div class="info">
                            <p>
                                <span>邮箱  </span>
                                {if $detail.email}
                                    <em>{$detail.email} 已绑定</em>
                                {else}
                                    <em style="color:red;">未绑定</em>
                                {/if}
                            </p>
                            <p>邮箱号用于接收网站重要的信息通知</p>
                        </div>
                        <div class="update">
                            <a class="layui-btn layui-btn-radius layui-bg-gray" lay-event="bindEmail">{$detail.email ? '更改' : '绑定'}</a>
                        </div>
                    </li>
                    <li>
                        <div class="icon">
                            <i class="layui-icon layui-icon-cellphone"></i>
                        </div>
                        <div class="info">
                            <p>
                                <span>手机  </span>
                                {if $detail.mobile}
                                    <em>{$detail.mobile} 已绑定</em>
                                {else}
                                    <em style="color:red;">未绑定</em>
                                {/if}
                            </p>
                            <p>手机号可用于登录或者密码找回等</p>
                        </div>
                        <div class="update">
                            <a class="layui-btn layui-btn-radius layui-bg-gray" lay-event="bindMobile">{$detail.mobile ? '更改' : '绑定'}</a>
                        </div>
                    </li>
                    <li>
                        <div class="icon">
                            <i class="layui-icon layui-icon-vercode"></i>
                        </div>
                        <div class="info">
                            <p>
                                <span>密码  </span>
                                <em>****** 已设置</em>
                            </p>
                            <p>密码很重要请谨慎保管不要泄露</p>
                        </div>
                        <div class="update">
                            <a class="layui-btn layui-btn-radius layui-bg-gray" lay-event="changePwd">更改</a>
                        </div>
                    </li>
                    <li>
                        <div class="icon">
                            <i class="layui-icon layui-icon-login-wechat"></i>
                        </div>
                        <div class="info">
                            <p>
                                <span>微信  </span>
                                {if $detail.isWeChat}
                                    <em>****** 已绑定</em>
                                {else}
                                    <em style="color:red;">未绑定</em>
                                {/if}
                            </p>
                            <p>可使用微信扫码快速登录</p>
                        </div>
                        <div class="update">
                            <a class="layui-btn layui-btn-radius layui-bg-gray" lay-event="bindWeChat">{$detail.isWeChat ? '更改' : '绑定'}</a>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
{/block}

{block name="js"}
<script>
    layui.use(['form', 'upload'], function () {
        let $ = layui.$;
        let form = layui.form;
        let upload = layui.upload;

        // 监听事件
        waitUtil.event({
            'changePwd': function () {
                waitUtil.popup({
                    title: '修改密码',
                    url: '/frontend/user/binding?field=changePwd',
                    area: ['320px', '300px'],
                    success: function (layero, index) {
                        layero.layui.form.on('submit(addForm)', function(data) {
                            const that = $(this);
                            waitUtil.locking(that);
                            if (data.field['newPassword'].length < 6 || data.field['newPassword'].length > 18) {
                                waitUtil.unlock(that);
                                return layer.msg('密码必须是6~18个字符内');
                            }

                            if (data.field['newPassword'] !== data.field['okPassword']) {
                                waitUtil.unlock(that);
                                return layer.msg('两次密码输入不一致');
                            }

                            waitUtil.ajax({
                                url: '/frontend/user/binding',
                                type: 'POST',
                                data: {
                                    field: 'changePwd',
                                    newPassword: data.field['newPassword'],
                                    oldPassword: data.field['oldPassword']
                                }
                            }).then((res) => {
                                waitUtil.unlock(that);
                                if (res.code === 0) {
                                    layer.close(index);
                                }
                            });
                        });
                    }
                });
            },
            'bindWeChat': function () {
                waitUtil.ajax({
                    url: '/frontend/login/opCodeUrl?url=https://waitadmin.cn',
                    type: 'GET',
                }).then((res) => {
                    console.info(res.data.url)
                    location.href = res.data.url
                });
            },
            'bindMobile': function () {
                waitUtil.popup({
                    title: '绑定手机号',
                    url: '/frontend/user/binding?field=bindMobile&value={$detail.mobile}',
                    area: ['320px', '220px'],
                    success: function (layero, index) {
                        layero.layui.form.on('submit(addForm)', function(data){
                            waitUtil.ajax({
                                url: '/frontend/user/binding',
                                type: 'POST',
                                data: {field: 'bindMobile', mobile: data.field['mobile'], code: data.field['code']}
                            }).then((res) => {
                                if (res.code === 0) {
                                    layer.close(index);
                                }
                            });
                        });
                    }
                });
            },
            'bindEmail': function () {
                waitUtil.popup({
                    title: '绑定邮箱',
                    url: '/frontend/user/binding?field=bindEmail&value={$detail.email}',
                    area: ['320px', '220px'],
                    maxmin: false,
                    success: function (layero, index) {
                        layero.layui.form.on('submit(addForm)', function(data){
                            waitUtil.ajax({
                                url: '/frontend/user/update',
                                type: 'POST',
                                data: {field: 'bindEmail', mobile: data.field['email'], code: data.field['code']}
                            }).then(res => {
                                if (res.code === 0) {
                                    layer.close(index);
                                }
                            });
                        });
                    }
                });
            }
        });

        // 账号更新
        form.on('submit(updateSubmit)', function(data) {
            layer.confirm('您确定要进行更新吗？', function(index) {
                layer.close(index);
                waitUtil.ajax({
                    url: '/frontend/user/edit',
                    type: 'POST',
                    data: data.field
                });
            });
        });

        // 修改头像
        form.on('submit(saveAvatar)', function(data) {
            const that = $(this)
            waitUtil.locking(that);
            layer.confirm('您确定要进行保存吗？', function(index) {

                layer.close(index);
                waitUtil.ajax({
                    url: '/frontend/user/binding',
                    type: 'POST',
                    data: {field: 'avatar', avatar: data.field['avatar']}
                }).then(() => {
                    waitUtil.unlock(that);
                });
            });
        });

        // 上传头像
        upload.render({
            elem: '#uploadAvatar'
            ,url: '/frontend/upload/temporary'
            ,field: 'file'
            ,accept: 'images'
            ,acceptMime: 'image/*'
            ,exts: 'jpg|png|jpeg'
            ,size: 1024 * 10
            ,data: {type: 'image'}
            ,done: function (res) {
                layer.msg(res.msg);
                if (res.code === 0) {
                    $('#avatar').val(res.data.url);
                    $('#uploadAvatar').attr('src', res.data.url);
                }
            }
        });
    });
</script>
{/block}